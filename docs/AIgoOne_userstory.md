AIgoOne算法管理平台的用户故事

我公司是专门从事视觉算法开发公司，公司提供两个平台产品：算法训练平台和算法应用平台，算法训练平台提供了数据标注、自动化训练、算法编排、部署等功能。AIgoOne主要和算法应用平台有关，算法应用平台部署在客户的算力设备上（可以是算力服务器，也可以是AI边缘盒子），算法应用平台的作用主要是对算法进行管理、监控、配置（功能清单详见docs/al_single_func_list.xlsx）。在实际项目应用中，往往会有多台算力设备，但算法应用平台每个算力设备必须部署一套，这样就产生了一个问题，客户如果要去管理算法，必须先登录到某台设备上访问算法应用平台。如果设备非常多，这是件比较麻烦的事情。另外算法应用平台的功能比较简单，往往满足不了客户的实际需求，因此，我有了开发AIgoOne的想法。

AIgoOne会遇到一个棘手的问题，对算法的管理，比如创建视频源、配置任务等功能是由AIgoOne来完成，还是在算法应用平台上完成呢？我觉得可以分成两个步骤展开，第一步将AIgoOne进作为一个集成管理的平台，具体的配置操作都是在算法应用平台上去完成，AIgoOne可以跨设备查看算法相关视频源、任务、事件，并尽量优化这些功能；第二步再尝试解决统一管理的功能，即用户不在需要在具体的算力设备上通过算法应用平台进行配置管理，而都是有AIgoOne来完成。不过麻烦在于永远不可能完全规避用户在两头操作的可能性，即用户有时候在AIgoOne上创建任务或添加视频源，有时候又去算法应用平台上操作，这会比较复杂。

下面的方案和思路也主要针对第一步，但不论如何，AIgoOne都需要借助算法应用平台的API接口来完成功能（详见docs/al_single_api.md）

<h2 id="jQ4Z1">设备管理</h2>
用户要使用AIgoOne，首先需要将所有的算法应用平台（和具体的算力设备一一对应）都添加进来，这需要调用算法应用平台的API，用户在界面上提供算法应用平台的url、用户名、密码。AIgoOne则通过调用算法应用平台的登录（获取token，且永久有效）和设备信息接口，并进行本地化存储。这涉及到同步的问题，设备可能在线也可能变更也可能不在线，AIgoOne有两种测试，要么在后台有轮询的任务定制的刷新设备信息，要么有必要的时候才同步。我更倾向于后者。

此外，由于算法应用平台将算法模型与设备直接绑定（授权给这台设备），设备管理里还需要展示除设备基本信息以外的算法，即有哪些算法与这台设备有关，这可能会比较多的算法，需要分页或者滚动，支持查询过滤

<h2 id="b0AJC">业务树管理</h2>
业务树实际上为客户提供了一种管理与算法有关元素（视频源、任务、事件等）的框架，客户可以完全自定义这课树，用客户自己的业务层级来建立这棵树，比如某停车场运营管理公司，有30家停车场，他可以这样创建树：XXX停车场管理公司-海淀区-分区03-停车场A；一个工业园区的客户可以这样创建：XXX工业园-北区-芯片工厂101。叶子节点是业务管理的最小单元，比如芯片工厂101（即树的层级到这里就结束了），最小业务单元就对应着具体的视频源、任务、事件的查看或管理功能。

假设一个工业园区使用了9台算能SE7的AI边缘盒子，每台盒子接入了5个视频流，每个视频流上都运行了3个算法。AIgoOne允许客户将任意设备上的任意视频源与最小业务单元绑定，且可以重复绑定（但最好提示客户），一旦确定了最小业务单元与视频源的关系，也就知道了最小业务单元与任务、事件的关系，因为任务就是将算法和视频源绑定形成一个任务，事件就是任务执行的结果。这样用户就可以从最小业务单元的角度查看算法有关的视频源、任务、事件等。

所以使用AIgoOne的第二步用户需要创建业务树，创建时用户需要配置叶子结点和视频源的映射关心，如果一个叶子节点已经创建了映射，它下面就不能再创建子节点，另外实际配置的时候映射关心是先让用户选择设备，再选择设备下的视频源。

<h2 id="DLiIz">视频源管理</h2>
这部分指用户选择了某个最小业务单元（业务树上的叶子节点）后需要进行跟算法有关的操作，首先是对视频源进行管理，明确业务单元与算法的关联，比如一个停车场A有哪些摄像头？一个工厂101有哪些摄像头？AIgoOne需要从设备上获取摄像头和视频文件（请注意，这里依然是我们整体叙事中的第一步，即AIgoOne进作为一个集成管理的平台，具体的配置操作都是在算法应用平台上去完成；另外视频文件最好不要下载到AIgoOne一份）,原理上用户需要先从选择设备，再选择视频源。

视频源被添加到AIgoOne后，需要本地进行存储，因为要记录最小业务单元与视频源和设备的映射关系。这里需要注意如果用户后续在设备上的算法应用平台里删除了某个视频源，AIgoOne是不知道的，这里可能需提供一个手工批量同步的功能，对已经添加到AIgoOne平台中的视频源与具体设备上的算法应用平台中的视频源进行对照，发现信息变化则更新，如果该视频源已经被删除则进行提示，用户确认后也在AIgoOne中删除。但手动的批量同步功能不能解决用户还是会点击了一个已经在算法应用平台被删除的视频源。也就是说每次点击具体的视频源进行播放的时候还要在设备上的算法应用平台去同步信息。如果视频源地址变更了，则自动同步后进行后续应该的操作（播放视频），如果该视频源被删除了或出现了影响播放操作无法进行的时候，则需要提示给客户已经变更了需要删除掉了。以上视频源因为都存储在了AIgoOne的后台数据库中，所以同步都要更新数据库表记录

至于视频源的播放可以使用video标签，在前端解码播放，后台只提供视频源地址（视频文件的地址也是使用算法应用平台的，AIgoOne不做本地存储）

<h2 id="P3yoC">任务管理</h2>
当最小业务单元和视频源关联后，我们就知道了最小业务单元下有哪些任务，任务本质上就是将视频源和算法模型进行关联，即明确一个视频流上会运行哪些算法模型，这里还设计到很多配置工作，比如算法的ROI区域、显示算法的哪些标签等等。AIgoOne从算法应用平台获取与视频源有关的任务，任务也涉及到点击播放，但播放的画面中会有算法运行的结果，即标注框，且目前算法应用平台还不支持多个算法的标注框在一个视频流上展示，即假设一个视频源上运行了3个算法，但在任务管理点击任务预览时，需要切换算法来分别看结果。这里其实是AIgoOne想突破第一个点，但貌似比较有难度，因为目前AIgoOne只能依赖算法应用平台的API来实现功能，希望以后能够基于算法应用平台的源代码来实现突破。

任务管理中包括对算法运行结果的预览功能，即在视频流上看到被标注的目标物，这个功能在算法应用平台是这样来实现的：  
**完整的工作流程是这样的：**

    1. **服务器端**：
        * 算法程序从视频源（摄像头或视频文件）读取一帧。
        * 对这一帧图像运行您的识别算法（人、车、物检测）。
        * 将识别结果（比如绘制了边界框和标签）直接画在这一帧图像上。
        * 将这张处理后的图像编码成JPEG格式，再进行Base64编码。
        * 将这个Base64字符串作为JSON数据的一部分，通过API返回给前端。
    2. **前端**：
        * 使用 `setInterval` 或类似的机制，定期向后台API发起请求。
        * 收到包含Base64图片数据的新JSON后，立即更新界面上一个`<img>`标签的`src`属性。
        * 由于这个过程非常快（比如每秒5-15次），人眼就会将快速连续替换的静态图片感知为动态的视频。

这种技术通常被称为 **Motion JPEG (MJPEG) over HTTP**。

任务预览功能目前也只能采用一样的方案，但融合平台希望能够对算法应用平台的功能增强，所以还需要考虑两个方面的内容：

多算法的识别结果的融合，即在一个任务预览中看到多种算法的识别结果（标注）;另外，事件预警的时候目前算法应用平台给出的是图片，客户可能更想要实时是视频流（带算法标注的），这块的方案可以参考文档docs/video_des.md；但这种增强功能在第一阶段是不需要考虑的。

<h2 id="sDXaU">事件管理</h2>
是用户最常用的功能，因为可能不太可能一直盯着任务看结果，只有在发生预警事件的时候，客户可能会来查看页面，设置是接收短信、邮件，在客户有指挥大厅的时候更希望提供语音播报的功能。

事件查看的角度依然是以最小业务单元为单位，用户希望以卡片的方式展示事件，最新的事件在最前面，当任务中配置中某个算法开启了告警设置，则需要通过语音来播报预警文字，默认规则是最小业务单位名称+预警文字（比如，停车场A火焰烟雾预警）；也允许用户配置是否将最新的预警事件弹出在最前面，但这里可能会有个问题，就是预警有可能在短时间内产生多个，比如在12分12秒的时候出现了事件1，然后界面上弹出了该预警，但在12分14秒又出现了一个预警，是否要把之前弹出的预警关闭弹出新的呢？





