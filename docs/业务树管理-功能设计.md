### ****
**模块：业务树管理 (Business Tree Management)**

| **版本** | **修订日期** | **修订人** | **修订说明** |
| --- | --- | --- | --- |
| 1.0 | 2025-08-07 | 总设计师 | 初稿，根据需求方确认细节完成 |


#### 1. 功能概述 (Objective)
业务树管理是 AIgoOne 平台的核心功能之一。它旨在为用户提供一个灵活、直观的框架，用于根据其自身的业务层级（如地理位置、组织架构等）来组织和管理所有接入的、分散在不同算力设备上的视频源。

通过将视频源与业务树的叶子节点进行绑定，用户可以从业务视角而非物理设备视角，实现对相关视频源、分析任务和告警事件的统一查看与管理，从而极大简化多设备、多算法场景下的管理复杂度。

#### 2. 功能需求 (Functional Requirements)
**2.1. 树形结构定义**

+ **FR1.1 - 单根节点树：** 系统应支持单根节点，所有业务层级都在此根节点下展开。
+ **FR1.2 - 节点层级与数量限制：**
    - 业务树的最大层级深度不得超过 **5** 层。
    - 任何一个父节点下的直接子节点数量不得超过 **100** 个。
+ **FR1.3 - 节点命名规则：**
    - 节点名称由用户自定义，长度限制为1-64个字符。
    - 在同一个父节点下，所有直接子节点的名称必须唯一。

**2.2. 节点管理操作**

+ **FR2.1 - 创建节点：** 用户可以选择任意一个现有节点，在其下创建新的子节点。根节点是默认的创建起点。
+ **FR2.2 - 重命名节点：** 用户可以对任意节点（包括根节点）进行重命名。
+ **FR2.3 - 删除节点：**
    - 用户可以删除没有子节点的节点。
    - 若节点已绑定视频源，删除前需提示用户“该节点已绑定N个视频源，删除后将解除所有绑定关系，是否确认删除？”。
    - 若节点下存在子节点，则禁止删除，并提示用户“请先删除所有子节点”。
+ **FR2.4 - 移动节点（拖拽）：**
    - **允许的操作：** 仅允许用户拖拽**叶子节点**到**其他非叶子节点**下，实现归属关系的变更。
    - **禁止的操作：** 禁止拖拽非叶子节点；禁止将叶子节点拖拽成根节点或到其他叶子节点下。

**2.3. 视频源绑定管理**

+ **FR3.1 - 绑定入口：** 绑定操作的对象必须是**叶子节点**。当用户选中一个叶子节点时，系统应提供“绑定视频源”的交互入口。
+ **FR3.2 - 绑定流程与搜索：**
    - 绑定流程分为两步：选择设备 -> 选择该设备下的视频源。
    - **设备选择：** 系统需提供一个设备列表供用户选择。该列表应支持按设备名称或URL进行**搜索和筛选**。
    - **视频源选择：** 选定设备后，系统通过调用该设备上算法应用平台的API（参考`GET /v1/cameras`），获取其下所有的视频源列表。该列表应支持按视频源名称进行**搜索和筛选**。
+ **FR3.3 - 绑定数量：** 对单个叶子节点可绑定的视频源数量**不设上限**。
+ **FR3.4 - 重复绑定提示：** 在视频源选择列表中，系统需明确标识出已绑定到AIgoOne中**任意**业务节点的视频源。当用户勾选一个已绑定的视频源时，无需阻断，但在最终保存时应给出提示：“您选择的部分视频源已绑定到其他业务节点，确认继续吗？”。
+ **FR3.5 - 解除绑定：** 用户可以随时查看叶子节点已绑定的视频源列表，并对其中任意一个或多个进行解除绑定操作。

**2.4. 数据模型与存储**

+ **FR4.1 - 节点数据：** AIgoOne后端需建立`business_tree_nodes`表，存储节点ID、节点名称、父节点ID、层级深度等信息。
+ **FR4.2 - 绑定关系数据：** AIgoOne后端需建立`node_source_mappings`表，用于存储绑定关系，核心字段为 `mapping_id`, `node_id`, `device_id`, `source_id` (视频源ID)。
+ **FR4.3 - 数据关联：** 业务树节点与视频源的绑定关系，是后续在视频源管理、任务管理、事件管理中，按业务维度筛选数据的核心依据。

**2.5. 数据同步与状态显示**

+ **FR5.1 - 状态标记：** 当一个已绑定的视频源在源设备上被删除或无法访问时，AIgoOne不应自动删除该绑定关系。
+ **FR5.2 - UI表现：** 在叶子节点的已绑定视频源列表中，该视频源应被明确标记为“**失效**”或“**源已删除**”状态，并显示灰色或警告图标。
+ **FR5.3 - 用户操作：** 用户可以手动解除与这些“失效”视频源的绑定关系。当用户尝试对“失效”视频源进行播放等操作时，系统应提示“该视频源已不存在或无法访问，请检查源设备配置或解除绑定”。
+ **FR5.4 - 同步机制：** 遵循“设备管理”模块中定义的同步策略（如手动触发设备级的同步），同步结果将影响绑定关系的状态显示。

---

#### 3. 关键工作流程与UI/UX概念
**3.1. 业务树维护界面**

+ **功能入口：现有首页界面左侧下方“设置与帮助”增加菜单选项“业务树管理”，点击后弹出窗口（较大，可支持全屏）**
+ **页面布局如下：**
    - **左侧面板：** 以可展开/折叠的树形控件展示完整的业务树结构。提供“添加子节点”、“重命名”、“删除”等右键菜单或按钮操作。当选中**非叶子节点**时，展开或折叠子节点
    - **右侧面板：**
        * 当选中**叶子节点**时，展示“**已绑定视频源**”以及该视频源所在设备名称，url地址
        * 树默认是全部展开的

**3.2. 绑定视频源流程 (概念)**

1. 用户在左侧业务树选中一个叶子节点，如“停车场A”。
2. 点击右侧面板中的“绑定视频源”按钮。
3. 系统弹出“绑定视频源”模态框。
4. **步骤一：选择设备**
    - 模态框上方显示一个设备选择下拉框（下拉框中的内容来自设备管理功能维护的所有设备），并附带搜索框，用户可输入设备名称或url两者任意都可以过滤下拉框中是设备清单，列表实时筛选。
    - 用户选择一台设备，如“SE7-Box-01”。
5. **步骤二：选择视频源**
    - 模态框下方加载并显示“SE7-Box-01”上的所有视频源列表（通过图标区分是视频流还是视频文件），每行包含[复选框, 视频源名称, 状态（是否已在别处绑定）]。
    - 列表上方提供一个搜索框，用户可输入摄像头名称进行筛选。
    - 用户勾选需要的视频源，如“入口摄像头”、“出口摄像头”。
6. 点击“确认”按钮，系统保存绑定关系，并刷新“停车场A”节点的已绑定视频源列表。

#### 4.与算法管理平台API互动说明
| **AIgoOne 用户操作** | **触发的后端逻辑** | **调用的“算法应用平台”API** | **目的与说明** |
| --- | --- | --- | --- |
| 在绑定窗口中选择设备和**输入源类型**后 | 获取该设备上指定类型的视频源列表 | `GET /v1/sources`<br/> (并带上`type=camera`<br/> 或 `type=video`<br/>的查询参数) | 调用**指定设备**的API，精确拉取用户需要的摄像头**或**视频文件列表，供用户选择绑定。 |


Export to Sheets

