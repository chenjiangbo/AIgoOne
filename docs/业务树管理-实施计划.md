# AIgoOne 业务树管理功能 - 实施计划

## 一、项目概述

业务树管理是AIgoOne平台的核心功能模块，允许用户按照自己的业务逻辑（如地理位置、组织架构）来组织和管理分散在不同算力设备上的视频源。通过树形结构和视频源绑定，实现从业务视角而非物理设备视角的统一管理。

## 二、技术架构

### 2.1 技术栈选择

#### 前端技术栈
- **框架**: Vue 3 (Composition API)
- **UI组件库**: Element Plus
  - 核心组件：el-tree（树形控件）、el-dialog（对话框）
  - 表单组件：el-select、el-input、el-checkbox
- **CSS框架**: Tailwind CSS
  - 用途：快速样式定制、响应式布局、状态样式
  - 与Element Plus配合：组件使用Element Plus，布局和自定义样式使用Tailwind
- **状态管理**: Pinia
- **HTTP客户端**: Axios

#### 后端技术栈
- **框架**: FastAPI
- **数据库**: SQLite（开发）/ PostgreSQL（生产）
- **ORM**: SQLAlchemy
- **认证**: JWT + 角色权限

### 2.2 样式策略

```css
/* 组合使用示例 */
/* Element Plus组件 + Tailwind工具类 */
<el-tree class="border rounded-lg shadow-sm">
<div class="flex items-center justify-between p-4 hover:bg-gray-50">
```

优势：
- Element Plus提供成熟的交互组件
- Tailwind提供灵活的布局和样式定制
- 减少自定义CSS编写
- 保持界面一致性

## 三、数据库设计

### 3.1 业务树节点表 (business_tree_nodes)

```sql
CREATE TABLE business_tree_nodes (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    name VARCHAR(64) NOT NULL,              -- 节点名称
    parent_id INTEGER,                      -- 父节点ID，根节点为NULL
    depth INTEGER DEFAULT 0,                -- 层级深度，根节点为0
    is_leaf BOOLEAN DEFAULT FALSE,          -- 是否叶子节点
    path VARCHAR(255),                      -- 节点路径，如 "/1/2/3"
    visible_roles JSON,                     -- 可见角色列表 ["admin", "operator"]
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    created_by INTEGER,                     -- 创建用户ID
    updated_by INTEGER,                     -- 更新用户ID
    FOREIGN KEY (parent_id) REFERENCES business_tree_nodes(id) ON DELETE CASCADE,
    CONSTRAINT check_depth CHECK (depth <= 5),
    CONSTRAINT unique_name_per_parent UNIQUE (parent_id, name)
);

-- 创建索引
CREATE INDEX idx_parent_id ON business_tree_nodes(parent_id);
CREATE INDEX idx_path ON business_tree_nodes(path);
```

### 3.2 视频源绑定关系表 (node_source_mappings)

```sql
CREATE TABLE node_source_mappings (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    node_id INTEGER NOT NULL,               -- 业务树节点ID
    device_id INTEGER NOT NULL,             -- 设备ID
    source_id VARCHAR(255) NOT NULL,        -- 视频源ID（设备返回的原始ID）
    source_type VARCHAR(20),                -- 视频源类型：camera/video
    source_name VARCHAR(255),               -- 视频源名称（缓存）
    status VARCHAR(20) DEFAULT 'normal',    -- 状态：normal/invalid
    last_sync_at TIMESTAMP,                 -- 最后同步时间
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (node_id) REFERENCES business_tree_nodes(id) ON DELETE CASCADE,
    FOREIGN KEY (device_id) REFERENCES devices(id) ON DELETE CASCADE,
    CONSTRAINT unique_source_per_node UNIQUE (node_id, device_id, source_id)
);

-- 创建索引
CREATE INDEX idx_node_id ON node_source_mappings(node_id);
CREATE INDEX idx_device_source ON node_source_mappings(device_id, source_id);
```

## 四、API设计

### 4.1 业务树管理API

| 方法 | 路径 | 描述 | 权限 |
|------|------|------|------|
| GET | /api/business-tree | 获取完整业务树 | 所有角色（按角色过滤） |
| GET | /api/business-tree/nodes/{id} | 获取节点详情 | 所有角色 |
| POST | /api/business-tree/nodes | 创建节点 | admin |
| PUT | /api/business-tree/nodes/{id} | 更新节点 | admin |
| DELETE | /api/business-tree/nodes/{id} | 删除节点 | admin |
| POST | /api/business-tree/nodes/{id}/move | 移动节点 | admin |

### 4.2 视频源绑定API

| 方法 | 路径 | 描述 | 权限 |
|------|------|------|------|
| GET | /api/business-tree/nodes/{id}/sources | 获取节点绑定的视频源 | 所有角色 |
| POST | /api/business-tree/nodes/{id}/bind | 绑定视频源 | admin |
| DELETE | /api/business-tree/nodes/{id}/unbind | 解绑视频源 | admin |
| POST | /api/business-tree/nodes/{id}/sync | 同步视频源状态 | admin |
| GET | /api/devices/{id}/sources | 获取设备视频源列表 | admin |

### 4.3 批量操作API

| 方法 | 路径 | 描述 | 权限 |
|------|------|------|------|
| POST | /api/business-tree/batch-save | 批量保存所有更改 | admin |
| POST | /api/business-tree/validate | 验证树结构合法性 | admin |

## 五、前端组件设计

### 5.1 组件结构

```
frontend/src/components/business/
├── BusinessTreeDialog.vue          # 主对话框容器
├── tree/
│   ├── BusinessTreePanel.vue       # 左侧树形面板
│   ├── TreeNodeMenu.vue            # 右键菜单组件
│   └── TreeNodeEditor.vue          # 节点编辑器
├── source/
│   ├── SourceBindingPanel.vue      # 右侧视频源面板
│   ├── SourceBindingModal.vue      # 绑定视频源弹窗
│   └── SourceListTable.vue         # 视频源列表表格
└── utils/
    ├── treeHelpers.js               # 树操作辅助函数
    └── validators.js                # 验证函数
```

### 5.2 Pinia Store设计

```javascript
// stores/businessTree.js
export const useBusinessTreeStore = defineStore('businessTree', {
  state: () => ({
    // 树数据
    treeData: [],
    originalTreeData: [],  // 原始数据，用于比较变化
    
    // 选中状态
    selectedNode: null,
    expandedNodes: [],
    
    // 视频源绑定
    nodeSourceMappings: {},  // { nodeId: [sources] }
    
    // 编辑状态
    pendingChanges: {
      added: [],      // 新增节点
      updated: [],    // 修改节点
      deleted: [],    // 删除节点
      moved: [],      // 移动节点
      bindings: []    // 绑定变更
    },
    
    // UI状态
    loading: false,
    saving: false,
    hasUnsavedChanges: false
  }),
  
  getters: {
    // 获取可拖拽节点
    draggableNodes: (state) => {},
    // 获取叶子节点
    leafNodes: (state) => {},
    // 根据角色过滤的树
    filteredTree: (state) => {}
  },
  
  actions: {
    // 加载树数据
    async loadTree() {},
    // 保存所有更改
    async saveChanges() {},
    // 节点操作
    addNode() {},
    updateNode() {},
    deleteNode() {},
    moveNode() {},
    // 视频源绑定
    bindSources() {},
    unbindSources() {}
  }
})
```

## 六、实施阶段

### 第一阶段：后端数据模型与基础API（Day 1）

#### 任务清单
1. **数据库初始化**
   - 创建business_tree_nodes表
   - 创建node_source_mappings表
   - 添加初始根节点数据（"业务管理"）

2. **模型层开发**
   ```python
   # models/business.py
   class BusinessTreeNode(Base):
       __tablename__ = "business_tree_nodes"
       # 字段定义
       # 关系定义
   
   class NodeSourceMapping(Base):
       __tablename__ = "node_source_mappings"
       # 字段定义
   ```

3. **服务层开发**
   ```python
   # services/business_tree_service.py
   class BusinessTreeService:
       def get_tree(self, user_roles)
       def create_node(self, parent_id, name)
       def update_node(self, node_id, data)
       def delete_node(self, node_id)
       def validate_tree_constraints(self)
   ```

4. **API路由实现**
   ```python
   # api/business.py
   @router.get("/business-tree")
   @router.post("/business-tree/nodes")
   # 其他路由...
   ```

### 第二阶段：前端基础界面（Day 2）

#### 任务清单
1. **添加菜单入口**
   - 在"设置与帮助"下拉菜单添加"业务树管理"选项
   - 添加权限判断（仅admin可见）

2. **创建主对话框**
   ```vue
   <!-- BusinessTreeDialog.vue -->
   <template>
     <BaseDialog
       v-model:visible="visible"
       title="业务树管理"
       :width="'90%'"
       :show-maximize="true"
       class="business-tree-dialog"
     >
       <div class="flex h-full">
         <!-- 左侧树形面板 -->
         <BusinessTreePanel class="w-1/2" />
         <!-- 右侧绑定面板 -->
         <SourceBindingPanel class="w-1/2" />
       </div>
     </BaseDialog>
   </template>
   ```

3. **实现树形面板**
   - 集成el-tree组件
   - 配置默认展开、节点图标
   - 实现搜索过滤功能

4. **Pinia Store初始化**
   - 创建businessTree store
   - 实现数据加载和缓存

### 第三阶段：节点操作功能（Day 3）

#### 任务清单
1. **右键菜单实现**
   ```vue
   <el-dropdown @command="handleCommand">
     <el-dropdown-menu>
       <el-dropdown-item command="add">添加子节点</el-dropdown-item>
       <el-dropdown-item command="rename">重命名</el-dropdown-item>
       <el-dropdown-item command="delete">删除</el-dropdown-item>
     </el-dropdown-menu>
   </el-dropdown>
   ```

2. **节点CRUD操作**
   - 添加节点对话框
   - 行内编辑重命名
   - 删除确认提示

3. **拖拽功能实现**
   ```javascript
   // 拖拽配置
   const allowDrag = (node) => {
     return node.data.is_leaf && !node.data.has_mappings
   }
   
   const allowDrop = (draggingNode, dropNode, type) => {
     // 只能拖到非叶子节点内部
     if (dropNode.data.is_leaf) return false
     if (type !== 'inner') return false
     // 检查层级限制
     if (dropNode.level >= 4) return false
     return true
   }
   ```

4. **约束验证**
   - 层级深度检查（最多5层）
   - 子节点数量检查（最多100个）
   - 名称唯一性检查

### 第四阶段：视频源绑定功能（Day 4）

#### 任务清单
1. **绑定面板开发**
   ```vue
   <!-- SourceBindingPanel.vue -->
   <template>
     <div class="p-4">
       <div v-if="!selectedNode" class="text-gray-500 text-center">
         请选择叶子节点进行视频源绑定
       </div>
       <div v-else>
         <el-button @click="showBindingModal">绑定视频源</el-button>
         <SourceListTable :sources="bindedSources" />
       </div>
     </div>
   </template>
   ```

2. **绑定弹窗实现**
   - 设备选择（带搜索）
   - 视频源列表加载
   - 多选和状态显示

3. **设备API集成**
   ```javascript
   // 获取设备视频源
   async function fetchDeviceSources(deviceId) {
     try {
       const response = await api.get(`/devices/${deviceId}/sources`)
       return response.data
     } catch (error) {
       if (error.response?.status === 503) {
         ElMessage.error('设备离线，无法获取视频源')
       }
       return []
     }
   }
   ```

4. **批量操作**
   - 批量解绑功能
   - 批量状态同步

### 第五阶段：集成与优化（Day 5）

#### 任务清单
1. **统一保存机制**
   ```javascript
   // 保存按钮和状态提示
   const saveChanges = async () => {
     if (!hasUnsavedChanges.value) return
     
     try {
       saving.value = true
       await api.post('/business-tree/batch-save', pendingChanges.value)
       ElMessage.success('保存成功')
       await loadTree() // 重新加载
     } catch (error) {
       ElMessage.error('保存失败：' + error.message)
     } finally {
       saving.value = false
     }
   }
   ```

2. **性能优化**
   - 虚拟滚动（大量节点）
   - 防抖搜索
   - 懒加载子节点

3. **用户体验优化**
   - 未保存提示
   - 操作确认对话框
   - 加载和保存状态显示
   - 键盘快捷键

4. **与首页集成**
   - 共享store数据
   - 自动刷新机制
   - 选中状态同步

## 七、关键技术实现

### 7.1 权限控制实现

```python
# 后端权限装饰器
def require_role(roles: List[str]):
    def decorator(func):
        @wraps(func)
        async def wrapper(*args, **kwargs):
            current_user = kwargs.get('current_user')
            if not any(role in current_user.roles for role in roles):
                raise HTTPException(status_code=403, detail="权限不足")
            return await func(*args, **kwargs)
        return wrapper
    return decorator

# 使用示例
@router.post("/business-tree/nodes")
@require_role(['admin'])
async def create_node():
    pass
```

### 7.2 批量保存事务处理

```python
async def batch_save_changes(changes: dict, db: Session):
    try:
        # 开启事务
        db.begin()
        
        # 1. 处理删除
        for node_id in changes['deleted']:
            db.query(BusinessTreeNode).filter_by(id=node_id).delete()
        
        # 2. 处理新增
        for node_data in changes['added']:
            node = BusinessTreeNode(**node_data)
            db.add(node)
        
        # 3. 处理更新
        for node_data in changes['updated']:
            db.query(BusinessTreeNode).filter_by(
                id=node_data['id']
            ).update(node_data)
        
        # 4. 处理移动
        for move_data in changes['moved']:
            update_node_path(move_data['node_id'], move_data['new_parent_id'])
        
        # 5. 处理绑定关系
        process_binding_changes(changes['bindings'])
        
        # 提交事务
        db.commit()
        return {"success": True}
        
    except Exception as e:
        db.rollback()
        raise e
```

### 7.3 视频源唯一标识策略

```javascript
// 组合唯一标识
function getSourceUniqueId(deviceId, sourceId) {
  return `${deviceId}_${sourceId}`
}

// 检查重复绑定
function checkDuplicateBinding(sourceId, deviceId) {
  const uniqueId = getSourceUniqueId(deviceId, sourceId)
  return allBindings.some(binding => 
    getSourceUniqueId(binding.device_id, binding.source_id) === uniqueId
  )
}
```

## 八、测试计划

### 8.1 单元测试
- 树结构约束验证
- 权限控制测试
- API接口测试

### 8.2 集成测试
- 前后端联调测试
- 设备API集成测试
- 批量保存测试

### 8.3 性能测试
- 大量节点（1000+）渲染性能
- 拖拽操作响应时间
- 批量保存性能

### 8.4 用户体验测试
- 操作流畅性
- 错误提示准确性
- 界面响应速度

## 九、风险与对策

| 风险 | 影响 | 对策 |
|------|------|------|
| 设备API不稳定 | 无法获取视频源 | 增加重试机制和缓存 |
| 大量节点性能问题 | 界面卡顿 | 实现虚拟滚动和懒加载 |
| 并发编辑冲突 | 数据不一致 | 实现乐观锁机制 |
| 权限配置错误 | 安全问题 | 严格的权限测试 |

## 十、时间安排

- **Day 1**: 后端数据模型与基础API
- **Day 2**: 前端基础界面
- **Day 3**: 节点操作功能
- **Day 4**: 视频源绑定功能
- **Day 5**: 集成与优化
- **Day 6**: 测试与修复（预留）

## 十一、交付标准

1. **功能完整性**
   - 所有设计文档中的功能点实现
   - 通过所有测试用例

2. **性能指标**
   - 1000个节点渲染时间 < 2秒
   - 拖拽响应时间 < 100ms
   - 批量保存时间 < 5秒

3. **代码质量**
   - 代码覆盖率 > 80%
   - 无critical级别的代码问题
   - 完整的注释和文档

4. **用户体验**
   - 所有操作有明确反馈
   - 错误提示清晰准确
   - 界面美观一致

## 十二、后续优化方向

1. **功能增强**
   - 支持批量导入树结构
   - 支持树结构导出
   - 历史版本管理

2. **性能优化**
   - 增量更新机制
   - 前端数据缓存优化
   - WebSocket实时同步

3. **用户体验**
   - 拖拽时的视觉反馈增强
   - 快捷操作工具栏
   - 批量操作向导

## 附录：参考资料

- [Element Plus Tree组件文档](https://element-plus.org/zh-CN/component/tree.html)
- [Tailwind CSS文档](https://tailwindcss.com/docs)
- [FastAPI文档](https://fastapi.tiangolo.com/)
- [Pinia文档](https://pinia.vuejs.org/)