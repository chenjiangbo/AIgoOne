**<font style="color:rgb(27, 28, 29);">模块：事件管理 (Event Management)</font>**

#### <font style="color:rgb(27, 28, 29);">1. 功能概述 (Objective)</font>
<font style="color:rgb(27, 28, 29);">事件管理是用户与AIgoOne平台交互最频繁、感知价值最直接的功能模块。它旨在聚合所有设备产生的告警事件，在与业务强关联的视图下（业务树）进行集中呈现，并提供包括</font>**<font style="color:rgb(27, 28, 29);">弹窗、声音、邮件、短信</font>**<font style="color:rgb(27, 28, 29);">在内的多维度、可配置的实时通知能力，确保用户能第一时间响应关键告警。V1.0版本将专注于事件的“</font>**<font style="color:rgb(27, 28, 29);">呈现</font>**<font style="color:rgb(27, 28, 29);">”与“</font>**<font style="color:rgb(27, 28, 29);">通知</font>**<font style="color:rgb(27, 28, 29);">”，暂不包含复杂的事件处置（Triage）流程。</font>

#### <font style="color:rgb(27, 28, 29);">2. 功能需求 (Functional Requirements)</font>
**<font style="color:rgb(27, 28, 29);">2.1. 事件查看与筛选</font>**

+ **<font style="color:rgb(27, 28, 29);">FR1.1 - 默认视图:</font>**<font style="color:rgb(27, 28, 29);"> 用户通过点击业务树叶子节点进入事件管理视图，默认以卡片形式、按</font>**<font style="color:rgb(27, 28, 29);">事件发生时间倒序</font>**<font style="color:rgb(27, 28, 29);">（最新的在前）展示与该业务节点关联的所有事件。</font>
+ **<font style="color:rgb(27, 28, 29);">FR1.2 - 事件卡片信息:</font>**<font style="color:rgb(27, 28, 29);"> 每个事件卡片需展示：</font>
    - <font style="color:rgb(27, 28, 29);">事件截图 (</font>`<font style="color:rgb(87, 91, 95);">thumb_url</font>`<font style="color:rgb(27, 28, 29);">)</font>
    - <font style="color:rgb(27, 28, 29);">业务单元名称 (来自业务树)</font>
    - <font style="color:rgb(27, 28, 29);">告警文字 (</font>`<font style="color:rgb(87, 91, 95);">alarm_effect.content</font>`<font style="color:rgb(27, 28, 29);">)</font>
    - <font style="color:rgb(27, 28, 29);">视频源名称 (</font>`<font style="color:rgb(87, 91, 95);">source_name</font>`<font style="color:rgb(27, 28, 29);">)</font>
    - <font style="color:rgb(27, 28, 29);">事件发生时间 (</font>`<font style="color:rgb(87, 91, 95);">created</font>`<font style="color:rgb(27, 28, 29);">)</font>
+ **<font style="color:rgb(27, 28, 29);">FR1.3 - 筛选条件:</font>**<font style="color:rgb(27, 28, 29);"> 列表上方需提供以下筛选控件，用户选择后列表实时刷新：</font>
    - **<font style="color:rgb(27, 28, 29);">任务:</font>**<font style="color:rgb(27, 28, 29);"> 下拉列表，可选择该业务节点下的所有任务。</font>
    - **<font style="color:rgb(27, 28, 29);">视频源:</font>**<font style="color:rgb(27, 28, 29);"> 下拉列表，可选择该业务节点下的所有视频源。</font>
    - **<font style="color:rgb(27, 28, 29);">算法:</font>**<font style="color:rgb(27, 28, 29);"> 下拉列表，可选择任务中包含的所有算法应用。</font>
    - **<font style="color:rgb(27, 28, 29);">时间范围:</font>**<font style="color:rgb(27, 28, 29);"> 提供预设（今天、近7天）和自定义时间范围选择器。</font>
+ **<font style="color:rgb(27, 28, 29);">FR1.4 - 业务节点过滤:</font>**<font style="color:rgb(27, 28, 29);"> 支持选择非叶子节点，以查看其下属所有叶子节点产生的全部事件。</font>

**<font style="color:rgb(27, 28, 29);">2.2. 事件详情查看（大窗口模式）</font>**

+ **<font style="color:rgb(27, 28, 29);">FR2.1 - 触发方式:</font>**
    1. <font style="color:rgb(27, 28, 29);">用户手动点击事件列表中的任意一个卡片。</font>
    2. <font style="color:rgb(27, 28, 29);">系统根据“实时通知”规则自动弹出（见FR3.1）。</font>
+ **<font style="color:rgb(27, 28, 29);">FR2.2 - 窗口内容:</font>**<font style="color:rgb(27, 28, 29);"> 弹出的为</font>**<font style="color:rgb(27, 28, 29);">模态对话框（Modal Dialog）</font>**<font style="color:rgb(27, 28, 29);">，居中显示，尺寸较大，包含：</font>
    - **<font style="color:rgb(27, 28, 29);">核心内容:</font>**<font style="color:rgb(27, 28, 29);"> 优先展示清晰的事件图片 (</font>`<font style="color:rgb(87, 91, 95);">preview_url</font>`<font style="color:rgb(27, 28, 29);">)。如果事件关联了视频 (</font>`<font style="color:rgb(87, 91, 95);">video_url</font>`<font style="color:rgb(27, 28, 29);">)，则提供播放视频的选项。</font>
    - **<font style="color:rgb(27, 28, 29);">辅助信息:</font>**<font style="color:rgb(27, 28, 29);"> 窗口一侧展示详细的元数据，如事件名称、时间、来源设备、来源视频源等。</font>
    - **<font style="color:rgb(27, 28, 29);">操作:</font>**<font style="color:rgb(27, 28, 29);"> 提供“跳转到源平台”的链接。V1.0</font>**<font style="color:rgb(27, 28, 29);">不提供</font>**<font style="color:rgb(27, 28, 29);">“有效”、“误报”等事件处置按钮。</font>

**<font style="color:rgb(27, 28, 29);">2.3. 实时通知 - 新事件弹窗</font>**

+ **<font style="color:rgb(27, 28, 29);">FR3.1 - 功能开关:</font>**<font style="color:rgb(27, 28, 29);"> 系统需提供一个全局配置项，允许用户开启或关闭“新事件自动弹窗”功能。</font>
+ **<font style="color:rgb(27, 28, 29);">FR3.2 </font>****触发规则:** 当一个新事件产生，且用户在系统设置中开启了“新事件自动弹窗”功能时，系统即自动触发弹窗。此功能**不依赖**于任何任务级别的“启用告警”配置。  <font style="color:rgb(27, 28, 29);"></font>
+ **<font style="color:rgb(27, 28, 29);">FR3.3 - 弹窗内容:</font>**<font style="color:rgb(27, 28, 29);"> 自动弹出的窗口与用户手动点击卡片弹出的“事件详情框”（FR2.2）</font>**<font style="color:rgb(27, 28, 29);">完全一致</font>**<font style="color:rgb(27, 28, 29);">。</font>
+ **<font style="color:rgb(27, 28, 29);">FR3.4 - 并发处理:</font>**<font style="color:rgb(27, 28, 29);"> 为避免多个弹窗覆盖造成混乱，</font>**<font style="color:rgb(27, 28, 29);">系统必须遵循以下规则</font>**<font style="color:rgb(27, 28, 29);">：如果当前屏幕上已经有一个“事件详情框”存在，则新来的事件</font>**<font style="color:rgb(27, 28, 29);">不再</font>**<font style="color:rgb(27, 28, 29);">弹出新的详情框，而是在当前详情框的某个位置（如标题栏）给出“您有N个新事件”的数字提示，并提供“查看下一个”的按钮。</font>

**<font style="color:rgb(27, 28, 29);">2.4. 实时通知 - 语音播报</font>**

+ **<font style="color:rgb(27, 28, 29);">FR4.1 - 技术实现:</font>**<font style="color:rgb(27, 28, 29);"> 采用浏览器内置的 </font>**<font style="color:rgb(27, 28, 29);">Web Speech API (TTS)</font>**<font style="color:rgb(27, 28, 29);"> 实现文字转语音。首次使用时由浏览器提示用户授权。</font>
+ **<font style="color:rgb(27, 28, 29);">FR4.2 - 触发规则:</font>**<font style="color:rgb(27, 28, 29);"> 当一个新事件产生，且该事件所属任务中的算法配置了“启用告警”，系统即触发语音播报。</font>
+ **<font style="color:rgb(27, 28, 29);">FR4.3 - 播报内容:</font>**<font style="color:rgb(27, 28, 29);"> 遵循“[业务单元名称] + [告警文字]”的格式。</font>
+ **<font style="color:rgb(27, 28, 29);">FR4.4 - 状态管理:</font>**<font style="color:rgb(27, 28, 29);"> AIgoOne平台需在内部维护事件的“新/旧”状态。一个事件一旦被加载到事件管理界面，即视为“旧”事件，不再触发语音播报和弹窗。只有在此之后由后端推送来的新事件，才被视为“新”事件。</font>
+ **<font style="color:rgb(27, 28, 29);">FR4.5 - 多页面行为:</font>**<font style="color:rgb(27, 28, 29);"> 遵从你的决策，如果用户在同一个浏览器打开了多个事件管理页面，</font>**<font style="color:rgb(27, 28, 29);">所有这些页面都会进行语音播报</font>**<font style="color:rgb(27, 28, 29);">。此设计虽然可能造成体验不佳，但可降低V1开发复杂度。我们将在V2.0版本中考虑优化为单页面播报。</font>

**<font style="color:rgb(27, 28, 29);">2.5. 实时通知 - 邮件</font>**

+ **<font style="color:rgb(27, 28, 29);">FR5.1 - 系统配置:</font>**<font style="color:rgb(27, 28, 29);"> AIgoOne需提供一个独立的系统设置页面，用于管理员配置全局唯一的</font>**<font style="color:rgb(27, 28, 29);">SMTP服务器信息</font>**<font style="color:rgb(27, 28, 29);">。</font>
+ **<font style="color:rgb(27, 28, 29);">FR5.2 - 接收人配置:</font>****<font style="color:rgb(27, 28, 29);">在“任务管理”模块</font>**<font style="color:rgb(27, 28, 29);">创建或编辑任务时，需提供一个配置项，让用户可以为</font>**<font style="color:rgb(27, 28, 29);">该任务</font>**<font style="color:rgb(27, 28, 29);">添加一个或多个邮件接收人地址。</font>
+ **<font style="color:rgb(27, 28, 29);">FR5.3 - 触发规则:</font>**<font style="color:rgb(27, 28, 29);"> 当一个事件产生，且该事件所属的任务已经配置了邮件接收人时，系统触发邮件发送流程。</font>
+ **<font style="color:rgb(27, 28, 29);">FR5.4 - 邮件内容:</font>**<font style="color:rgb(27, 28, 29);"> 邮件内容需包含关键信息，并</font>**<font style="color:rgb(27, 28, 29);">嵌入事件图片</font>**<font style="color:rgb(27, 28, 29);">。模板示例：</font>
    - **<font style="color:rgb(27, 28, 29);">标题:</font>**`<font style="color:rgb(87, 91, 95);">【AIgoOne 告警】停车场A发生火焰烟雾预警</font>`
    - **<font style="color:rgb(27, 28, 29);">正文:</font>**`<font style="color:rgb(87, 91, 95);">告警详情：<br>业务位置：停车场A<br>视频源：入口摄像头<br>告警算法：烟火识别<br>告警时间：2025-08-07 18:30:00<br><br>[嵌入的事件图片]</font>`

#### <font style="color:rgb(27, 28, 29);">3. 关于短信通知的V1范围建议</font>
+ **<font style="color:rgb(27, 28, 29);">架构师建议：</font>**<font style="color:rgb(27, 28, 29);"> 经过评估，这个前提在技术上难以低成本实现。每个短信服务商（百度、腾讯、阿里、Twilio等）的API认证、请求参数、返回格式都完全不同，无法用一套通用代码在不引入第三方库或不做大量适配逻辑的情况下支持。强行实现一个“通用网关”本身就是一个复杂项目，会给V1带来巨大风险和不确定性。</font>
+ **<font style="color:rgb(27, 28, 29);">结论：</font>**<font style="color:rgb(27, 28, 29);"> 我</font>**<font style="color:rgb(27, 28, 29);">强烈建议</font>**<font style="color:rgb(27, 28, 29);">将</font>**<font style="color:rgb(27, 28, 29);">短信通知功能从V1.0范围中移除</font>**<font style="color:rgb(27, 28, 29);">，集中精力确保邮件通知功能的稳定可靠。在V2.0中，我们可以选择1-2家主流短信服务商进行官方集成，以保证功能质量。</font>

#### 4<font style="color:rgb(27, 28, 29);"> 与算法应用平台的API交互说明</font>
| **AIgoOne 用户操作/功能** | **触发的后端逻辑** | **调用的“算法应用平台”API** | **目的与说明** |
| --- | --- | --- | --- |
| **查看/筛选事件列表** | AIgoOne后端根据业务节点绑定的视频源，向对应的**一个或多个**算法应用平台并发请求事件数据。 | `GET /v1/events` | 根据视频源ID (`source_id`<br/>)、任务ID (`task_id`<br/>)、算法ID (`app_id`<br/>) 和时间范围等参数，从每个设备拉取符合条件的事件列表。AIgoOne后端负责聚合所有结果。 |
| **接收新事件通知 (后台轮询)** | AIgoOne后端服务定期轮询，检查所有任务是否有新事件产生。 | `GET /v1/events` | 调用此接口并传入上次检查的时间戳作为`start`<br/>参数，以获取增量的新事件。 |
| **查看单个事件详情** | 当需要获取比列表页更完整的事件信息时（例如，加载高分辨率图片或关联的视频文件）。 | `GET /v1/events/{id}` | 根据事件ID获取单个事件的完整、详细的数据。 |


