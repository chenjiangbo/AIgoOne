### ****
**模块：任务管理 (Task Management)**

| **版本** | **修订日期** | **修订人** | **修订说明** |
| --- | --- | --- | --- |
| 1.4 | 2025-08-08 | 总设计师 | 终稿。明确V1范围为“任务浏览器”，定义任务查看、控制与预览功能。 |


#### 1. 功能概述 (Objective)
任务管理模块是 AIgoOne 平台的核心价值体现，它将抽象的“算法”和具体的“视频源”结合起来，执行分析任务。本模块旨在为用户提供一个集中化的视图，用于**浏览、监控和控制**所有从底层设备同步而来的任务。V1.0 阶段，本模块定位为“**任务浏览器**”，聚焦于对已有任务的**查看、启停控制和结果预览**，而不涉及任务的创建与配置。

#### 2. V1.0 功能范围 (Scope Definition)
为确保项目 V1.0 能够成功、快速地交付，以下功能被明确**排除**在此阶段范围之外，并规划于 V2.0 或更高版本实现：

+ **任务创建/编辑/删除:** 所有任务的生命周期管理（创建、修改算法配置、删除）**必须**在源头的“算法应用平台”上完成。AIgoOne 中不提供这些操作的界面。
+ **ROI 及算法参数配置:** AIgoOne V1.0 不提供任何形式的算法参数（`app_config`）或 ROI 区域的图形化配置界面。
+ **多算法结果融合:** 任务预览时，不支持在同一个视频画面中同时渲染多个算法的标注结果。
+ **任务导出:** 不支持导出任务配置。

#### 3. 功能需求 (Functional Requirements)
**3.1. 任务列表视图**

+ **FR1.1 - 入口:** 在“业务树管理”界面，当用户选中一个叶子节点时，右侧主内容区以标签页形式提供“**关联任务**”视图。
+ **FR1.2 - 数据来源:** 列表展示的数据，是 AIgoOne 后端通过查询该叶子节点绑定的所有视频源，再调用相应设备上的 `GET /v1/tasks` 接口（按 `input_id` 过滤）聚合而来的。
+ **FR1.3 - 列表信息:** 任务列表以卡片或表格形式展示，每条记录必须包含：
    - **任务名称:**`name`
    - **任务状态:**`status` (例如：运行中, 已停止, 失败, 流异常等)，并以不同颜色的图标或标签进行区分。
    - **关联算法:**`instances` 数组中每个元素的 `app_name`，以标签形式罗列。
    - **关联视频源:**`input_id` 对应的视频源名称。
    - **操作按钮:** 一组用于控制任务生命周期的按钮，包括“启动”、“停止”、“重启”、“预览”。

**3.2. 任务控制操作**

+ **FR2.1 - 启动/停止/重启:** 用户点击相应的操作按钮，AIgoOne 后端直接调用“算法应用平台”对应的 API 来执行。操作结果（成功/失败）需要通过界面提示反馈给用户，并刷新任务状态。

**3.3. 任务预览功能**

+ **FR3.1 - 预览入口:** 用户点击“预览”按钮，弹出一个模态对话框用于展示带标注的视频流。
+ **FR3.2 - 技术实现:** 预览功能严格遵循“算法应用平台”现有的 **Motion JPEG (MJPEG) over HTTP** 方案。
    - 前端通过 `setInterval` 机制，高频轮询 AIgoOne 后端提供的代理接口。
    - AIgoOne 后端接收到请求后，再调用源设备的 `GET /v1/task/preview` 接口，并将返回的 Base64 编码的 JPEG 图像数据透传给前端。
    - 前端持续刷新 `<img>` 标签的 `src` 属性，形成动态视频效果。
+ **FR3.3 - 多算法切换:** 如果一个任务关联了多个算法（`instances` 数组长度 > 1），在预览窗口中必须提供一个下拉框或标签页，允许用户**手动切换**查看不同算法的标注结果。一次只能预览一个算法的效果。

---

#### 4. 与算法应用平台的API交互说明
| **AIgoOne 用户操作** | **触发的后端逻辑** | **调用的“算法应用平台”API** | **目的与说明** |
| --- | --- | --- | --- |
| **查看关联任务列表** | 聚合与某业务节点相关的所有任务 | `GET /v1/tasks` | AIgoOne 后端根据业务节点绑定的视频源，向对应设备发起此API调用（并使用 `input_id`<br/> 参数进行过滤），获取任务列表及状态。 |
| **启动任务** | 向指定任务发送“启动”指令 | `PUT /v1/tasks/{id}/start` | 调用指定设备上对应任务ID的“启动”接口。 |
| **停止任务** | 向指定任务发送“停止”指令 | `PUT /v1/tasks/{id}/stop` | 调用指定设备上对应任务ID的“停止”接口。 |
| **重启任务** | 向指定任务发送“重启”指令 | `PUT /v1/tasks/{id}/restart` | 调用指定设备上对应任务ID的“重启”接口。 |
| **预览任务** | 代理并透传算法标注的视频流 | `GET /v1/task/preview` | AIgoOne 后端高频调用此接口（并传入 `instance_id`<br/> 来指定预览哪个算法），将获取到的 MJPEG 数据流转发给前端。 |


