

**模块：视频源管理 (Video Source Management)**

#### 1. 功能概述 (Objective)
视频源管理是用户与 AIgoOne 平台进行高频交互的核心界面。本功能模块旨在为用户提供一个统一、聚合的视图，用于查看、播放和管理所有已通过业务树绑定的视频源。

它将作为连接“业务逻辑层（业务树）”和“算法应用层（任务管理）”的关键桥梁，同时，通过严谨的数据同步和状态管理机制，解决因底层设备信息变更所导致的数据不一致问题，提升平台的稳定性和用户信任度。

#### 2. 功能视图 (Views)
系统需提供两种查看视频源的视图：

+ **2.1. 业务树上下文视图 (Contextual View):**
    - **入口:** 在“业务树管理”界面，选中任意**叶子节点**后，在右侧主内容区展示。
    - **内容:** 以卡片形式，仅显示与**当前选中叶子节点**绑定的所有视频源。这是面向日常业务操作人员的主要视图。
+ **2.2. 全局视频源视图 (Global View):**
    - **入口:** 在系统主导航中，提供一个独立的“视频源管理”或“全局视图”入口。
    - **内容:** 默认以卡片形式，展示**所有已纳管设备**上的**全部视频源**。提供强大的过滤和搜索功能，允许用户按所属设备进行筛选。此视图主要面向系统管理员，用于全局浏览和管理。

#### 3. 功能需求 (Functional Requirements)
**3.1. 视频源卡片展示**

+ **FR1.1 - 布局:** 视频源应以卡片（Card）形式平铺展示。
+ **FR1.2 - 卡片信息:** 每个卡片上必须清晰地展示以下信息：
    - **视频源封面图:** 调用算法应用平台API（`al_single_api.md` 中的 `GET /v1/cameras`）获取 `cover_url` 字段进行展示。
    - **在线/离线状态:** 调用API获取 `status` 字段，并在卡片上用不同颜色的图标或文字（如绿色-在线，灰色-离线）进行标识。
    - **视频源名称:** 显示 `name` 字段。
    - **流地址/文件路径:** 显示 `stream_url` 字段。
    - **分辨率:** 显示 `resolution` 字段。
    - **最近同步时间:** 记录用户每次成功发起播放或手动同步的时间戳，并展示在卡片上。

**3.2. 视频播放与详情**

+ **FR2.1 - 播放入口:** 用户点击任意视频源卡片，应弹出一个模态框（Modal）作为播放窗口。
+ **FR2.2 - 播放器:**
    - 播放器采用标准的 HTML5 `<video>` 标签实现。
    - 视频流地址直接使用从算法应用平台API获取的 `stream_url` 或 `preview_url`。AIgoOne **不做**视频流的转码或代理。
+ **FR2.3 - 信息面板:** 播放窗口的下方应包含一个信息面板，展示该视频源的详细技术信息。
    - **必须展示:** 状态、分辨率、帧率（FPS）。这些信息可从`GET /v1/cameras/{id}`接口直接获取。
    - **尽力而为:** 编码格式、码率。这些信息需要与算法应用平台团队确认其API是否能够提供，或能否通过低成本的技术手段从视频流中解析。如果实现代价过高，一期可作为“不支持”项。
+ **FR2.4 - 快捷操作:** 播放窗口中应提供以下快捷操作按钮：
    - **跳转到源平台:** 一个链接按钮，点击后在新标签页打开该视频源所在的算法应用平台的管理界面。
    - **解除绑定:** 仅在“业务树上下文视图”中点击播放时出现。点击后，解除当前视频源与当前叶子节点的绑定关系。
    - **从平台移除:** 仅在“全局视频源视图”中点击播放时出现。点击后，从AIgoOne中彻底移除该视频源记录，并解除其与所有叶子节点的绑定关系。

**3.3. 删除/解除绑定操作**

+ **FR3.1 - 定义:** 系统必须明确区分“解除绑定”和“从平台移除”。
    - **解除绑定 (Unbind):** 在业务树视图中操作，仅删除`node_source_mappings`表中对应的映射关系。
    - **从平台移除 (Remove):** 在全局视图中操作，除了删除所有相关的绑定关系外，还需从AIgoOne的视频源缓存表中删除该记录。
+ **FR3.2 - 用户确认:** 所有删除或解除绑定的操作前，都必须有二次弹窗确认，防止用户误操作。

**3.4. 数据同步机制**

+ **FR4.1 - 后台同步:** V1.0版本**暂不考虑**后台自动轮询同步机制，以降低系统复杂度和性能开销。
+ **FR4.2 - 点击时同步:**
    - 当用户点击视频卡片尝试播放时，AIgoOne后端必须先通过API（`GET /v1/cameras/{id}`）向源设备请求该视频源的最新信息。
    - **数据比对:** 将返回的信息与AIgoOne本地存储的信息进行比对。
    - **变更处理 (方案B):** 如果发现URL、名称等信息不一致，**必须**弹窗提示用户：“检测到该视频源信息已在源设备上发生变更，是否应用更新？”。用户点击“是”则更新本地数据并继续播放；点击“否”则取消本次操作。
    - **删除处理:** 如果API返回404或明确表示该视频源不存在，**必须**弹窗提示用户：“该视频源已在源设备上被删除，系统将标记为‘失效’状态，请及时处理。”，然后更新该视频源在AIgoOne中的状态为“失效”。

---

#### 4. API 交互说明
+ **外部API依赖:**
    - 获取视频源列表: `GET /v1/cameras`
    - 获取单个视频源详情/状态: `GET /v1/cameras/{id}`
+ **内部API需求 (AIgoOne 后端需实现):**
    - `GET /api/aigoone/v1/nodes/{id}/videosources`: 获取指定业务树叶子节点下绑定的所有视频源列表。
    - `GET /api/aigoone/v1/videosources`: 获取全局视频源列表，支持按`device_id`进行过滤。
    - `DELETE /api/aigoone/v1/mappings/{mapping_id}`: 解除单个绑定关系。
    - `DELETE /api/aigoone/v1/videosources/{source_id}`: 从AIgoOne平台移除一个视频源及其所有绑定关系。



